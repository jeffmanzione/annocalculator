<ng-container *ngIf="controller" [formGroup]="formGroup!">
  <section class="select-row">
    <mat-form-field>
      <mat-label>Island Name</mat-label>
      <input matInput type="text" formControlName="name">
    </mat-form-field>
    <enum-select class="island-select" formControlName="region" [options]="regions"
      [iconUrlLookupFn]="lookupRegionIconUrl"></enum-select>
    <enum-select class="island-select" formControlName="dolPolicy" [options]="dolPolicies"
      [iconUrlLookupFn]="lookupPolicyIconUrl"></enum-select>
  </section>
  <section>
    <button matButton="filled" color="primary" (click)="addProductionLine()">
      <mat-icon>add</mat-icon>
      Add Production Line
    </button>
  </section>
  <section>
    <table #productionLinesTable mat-table class="production-lines-table table-scroll"
      [dataSource]="productionLinesDataSource" multiTemplateDataRows>
      <ng-container matColumnDef="building">
        <th mat-header-cell *matHeaderCellDef>Building</th>
        <td mat-cell *matCellDef="let element" [formGroup]="element.formGroup">
          <enum-select formControlName="building" [options]="productionBuildings"
            [iconUrlLookupFn]="lookupBuildingIconUrl"></enum-select>
      </ng-container>
      <ng-container matColumnDef="numBuildings">
        <th mat-header-cell *matHeaderCellDef>Building Count</th>
        <td mat-cell *matCellDef="let element" [formGroup]="element.formGroup">
          <mat-form-field class="building-count">
            <input matInput type="text" inputmode="numeric" min="0" formControlName="numBuildings">
          </mat-form-field>
        </td>
      </ng-container>
      <ng-container matColumnDef="expandExtraGoods">
        <th mat-header-cell *matHeaderCellDef>EG</th>
        <td mat-cell *matCellDef="let element">
          <button mat-icon-button (click)="toggleShowExtraGoods(element)">
            <mat-icon [fontIcon]="element.expandExtraGoodsIcon"></mat-icon>
          </button>
        </td>
      </ng-container>
      <ng-container matColumnDef="good">
        <th mat-header-cell *matHeaderCellDef>Good</th>
        <td mat-cell *matCellDef="let element" [formGroup]="element.formGroup">
          <enum-select formControlName="good" [options]="goods" [iconUrlLookupFn]="lookupGoodIconUrl"></enum-select>
        </td>
      </ng-container>
      <ng-container matColumnDef="boosts">
        <th mat-header-cell *matHeaderCellDef>Boost Type</th>
        <td mat-cell *matCellDef="let element" [formGroup]="element.formGroup">
          <enum-select formControlName="boosts" [options]="element.allowedBoosts" [iconUrlLookupFn]="lookupBoostIconUrl"
            [multiple]="true"></enum-select>
        </td>
      </ng-container>
      <ng-container matColumnDef="hasTradeUnion">
        <th mat-header-cell *matHeaderCellDef>Trade Union</th>
        <td mat-cell *matCellDef="let element" [formGroup]="element.formGroup">
          <mat-checkbox formControlName="hasTradeUnion"></mat-checkbox>
        </td>
      </ng-container>
      <ng-container matColumnDef="tradeUnionItemsBonusPercent">
        <th mat-header-cell *matHeaderCellDef>Trade Union Bonus (%)</th>
        <td mat-cell *matCellDef="let element" [formGroup]="element.formGroup">
          <mat-form-field class="trade-bonus-field">
            <input matInput type="text" inputmode="numeric" min="0" formControlName="tradeUnionItemsBonusPercent">
          </mat-form-field>
        </td>
      </ng-container>
      <ng-container matColumnDef="inRangeOfLocalDepartment">
        <th mat-header-cell *matHeaderCellDef>In Range of Local Department</th>
        <td mat-cell *matCellDef="let element" [formGroup]="element.formGroup">
          <mat-checkbox formControlName="inRangeOfLocalDepartment"></mat-checkbox>
        </td>
      </ng-container>
      <ng-container matColumnDef="efficiency">
        <th mat-header-cell *matHeaderCellDef>Efficiency</th>
        <td mat-cell class="keep-top" *matCellDef="let element">
          <formatted-number [value]="element.efficiency" [isPercent]="true"></formatted-number>
        </td>
      </ng-container>
      <ng-container matColumnDef="buildingProcessTimeSeconds">
        <th mat-header-cell *matHeaderCellDef>Building Process Time</th>
        <td mat-cell class="keep-top" *matCellDef="let element">
          <formatted-number [value]="element.buildingProcessTimeSeconds" suffix="/s"></formatted-number>
        </td>
      </ng-container>
      <ng-container matColumnDef="goodProcessTimeSeconds">
        <th mat-header-cell *matHeaderCellDef>Good Process Time</th>
        <td mat-cell class="process-time keep-top" *matCellDef="let element">
          <formatted-number [value]="element.goodProcessTimeSeconds" suffix="/s"></formatted-number>
        </td>
      </ng-container>
      <ng-container matColumnDef="goodsProducedPerMinute">
        <th mat-header-cell *matHeaderCellDef>Production</th>
        <td mat-cell class="production-field keep-top" *matCellDef="let element">
          <formatted-number [value]="element.goodsProducedPerMinute" suffix="/m"></formatted-number>
        </td>
      </ng-container>
      <ng-container matColumnDef="remove">
        <th mat-header-cell *matHeaderCellDef>Remove</th>
        <td mat-cell *matCellDef="let element" class="remove-button" [formGroup]="element.formGroup">
          <button matIconButton (click)="removeProductionLineAt(element)">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>
      <ng-container matColumnDef="extraGoods">
        <td mat-cell *matCellDef="let element" [attr.colspan]="productionLineColumns.length" class="extra-goods-row">
          <div *ngIf="element.showExtraGoods" class="extra-goods-outer-container">
            <div class="extra-goods-inner-container">
              <button matButton="filled" color="primary" class="add-extra-good-button" (click)="addExtraGood(element)">
                <mat-icon>add</mat-icon>
                Add Extra Good
              </button>
              <table #extraGoodTables mat-table [dataSource]="element.extraGoods" class="extra-goods-table">
                <ng-container matColumnDef="good">
                  <td mat-cell *matCellDef="let element2" [formGroup]="element2.formGroup">
                    <enum-select formControlName="good" [options]="goods"
                      [iconUrlLookupFn]="lookupGoodIconUrl"></enum-select>
                  </td>
                </ng-container>
                <ng-container matColumnDef="rateNumerator">
                  <td mat-cell *matCellDef="let element2" [formGroup]="element2.formGroup">
                    <mat-form-field class="extra-goods-field">
                      <input matInput type="text" inputmode="numeric" min="1" formControlName="rateNumerator">
                    </mat-form-field>
                  </td>
                </ng-container>
                <ng-container matColumnDef="divideSymbol">
                  <th mat-header-cell *matHeaderCellDef>/</th>
                  <td mat-cell *matCellDef="let element2" [formGroup]="element2.formGroup">/</td>
                </ng-container>
                <ng-container matColumnDef="rateDenominator">
                  <td mat-cell *matCellDef="let element2" [formGroup]="element2.formGroup"
                    class="extra-goods-right-padding">
                    <mat-form-field class="extra-goods-field">
                      <input matInput type="text" inputmode="numeric" min="1" formControlName="rateDenominator">
                    </mat-form-field>
                  </td>
                </ng-container>
                <ng-container matColumnDef="processTimeSeconds">
                  <td mat-cell class="process-time keep-top" *matCellDef="let element2">
                    <formatted-number [value]="element2.processTimeSeconds" suffix="/s"></formatted-number>
                  </td>
                </ng-container>
                <ng-container matColumnDef="producedPerMinute">
                  <td mat-cell class="production-field keep-top" *matCellDef="let element2">
                    <formatted-number [value]="element2.producedPerMinute" suffix="/m"></formatted-number>
                  </td>
                </ng-container>
                <ng-container matColumnDef="remove">
                  <td mat-cell *matCellDef="let element2" class="remove-button">
                    <button matIconButton (click)="removeExtraGoodAt(element, element2)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>
                <tr mat-row *matRowDef="let row; columns: extraGoodColumns;"></tr>
              </table>
            </div>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="productionLineColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: productionLineColumns;" class="production-line-row"></tr>
      <tr mat-row *matRowDef="let row; columns: ['extraGoods']" class="extra-good-table-row"></tr>
    </table>
  </section>
</ng-container>